"use strict";(self.webpackChunk_2023_mm_presentation=self.webpackChunk_2023_mm_presentation||[]).push([[583],{191:(e,t,n)=>{e.exports=n.p+"631f8cfa3d6bae2a.bin"},9583:(e,t,n)=>{function i(e){return e`# Ptychography Helper Functions`}function a(e){return e.html`<hr class="hideable-md">`}function r(e){return e("https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.16/dist/numjs.min.js")}function o(e){return e("https://bundle.run/ndarray-ops@1.2.2")}function l(e){return e("https://bundle.run/ndarray-complex@1.0.3")}function s(e,t){return function(n,i){let a=e.zeros(n.shape);return t.atan2(a.selection,n.selection,i.selection),a}}function u(e,t){return function(n,i){let a=e.zeros(n.shape);return t.lts(a.selection,n.selection,i),t.bandseq(a.selection,1),a}}function c(e,t,n){return class i{constructor(t){this.shape=t;let n=t.slice();n.push(2),this.data=e.zeros(n),this._nulls=new Array(t.length).fill(null)}re(){return this.data.pick(...this._nulls,0)}im(){return this.data.pick(...this._nulls,1)}abs(){return e.sqrt(this.abs_sqr())}abs_sqr(){return e.add(this.re().multiply(this.re()),this.im().multiply(this.im()))}angle(){return t(this.im(),this.re())}clone(){let e=new i(this.shape);return e.data=this.data.clone(),e}conjugate(){let t=this.re().clone(),a=this.im().clone();n.conjeq(t.selection,a.selection);let r=new i(this.shape);return r.data=e.stack([t,a],-1),r}multiply(t){let a=this.re().clone(),r=this.im().clone(),o=t.re(),l=t.im();n.muleq(a.selection,r.selection,o.selection,l.selection);let s=new i(this.shape);return s.data=e.stack([a,r],-1),s}real_multiply(t){let a=this.re().clone(),r=this.im().clone(),o=t,l=e.zeros(t.shape);n.muleq(a.selection,r.selection,o.selection,l.selection);let s=new i(this.shape);return s.data=e.stack([a,r],-1),s}scalar_multiply(t,a){let r=this.re().clone(),o=this.im().clone();n.mulseq(r.selection,o.selection,t,a);let l=new i(this.shape);return l.data=e.stack([r,o],-1),l}add(t){let a=this.re().clone(),r=this.im().clone(),o=t.re(),l=t.im();n.addeq(a.selection,r.selection,o.selection,l.selection);let s=new i(this.shape);return s.data=e.stack([a,r],-1),s}subtract(t){let a=this.re().clone(),r=this.im().clone(),o=t.re(),l=t.im();n.subeq(a.selection,r.selection,o.selection,l.selection);let s=new i(this.shape);return s.data=e.stack([a,r],-1),s}}}function p(e){return function(t,n){let i=e.zeros(t),a=1/(t*n),r=1+((t-1)/2|0);for(var o=0;o<r;o++)i.set(o,o*a);for(o=r;o<t;o++)i.set(o,(o-t)*a);return i}}function d(e){return function(t,n){let i=[t.size,n.size],a=[];a[0]=e.zeros(i),a[1]=e.zeros(i);for(let e=0;e<i[1];e++)for(let r=0;r<i[0];r++)a[0].set(r,e,t.get(r)),a[1].set(r,e,n.get(e));return a}}function f(e){return function(t){let[n,i]=t.shape,a=n/2|0,r=i/2|0,o=e.zeros([n,i]);return o.slice([null,a],[null,r]).assign(t.slice(-a,-r),!1),o.slice([null,a],r).assign(t.slice(-a,[null,r]),!1),o.slice(-a,-r).assign(t.slice([null,a],[null,r]),!1),o.slice(-a,[null,r]).assign(t.slice([null,a],-r),!1),o}}function _(e,t,n,i){return function(a,r){let[o,l]=a.shape,[s,u]=r,c=new e([o,l]);c.data=t.fft(a.data);let p=n(o,1),d=n(l,1),[f,_]=i(p,d),m=-2*Math.PI,b=t.add(f.multiply(s),_.multiply(u)).multiply(m),h=new e([o,l]),v=t.cos(b),g=t.sin(b);h.data=t.stack([v,g],-1);let y=c.multiply(h);return y.data=t.ifft(y.data),y}}function m(e){return function(t,[n,i]){let a=new e([n,i]),r=n/2|0,o=i/2|0;return a.data.slice([null,r],[null,o],null).assign(t.slice([null,r],[null,o],null),!1),a.data.slice(-r,[null,o],null).assign(t.slice(-r,[null,o],null),!1),a.data.slice([null,r],-o,null).assign(t.slice([null,r],-o,null),!1),a.data.slice(-r,-o,null).assign(t.slice(-r,-o,null),!1),a}}function b(e,t,n){return function(i,a){let[r,o]=i.shape;console.log(r);let l=new e([r,o]);l.data=t.fft(i.data);let[s,u]=[r/a|0,o/a|0],c=n(l.data,[s,u]);return c.data=t.ifft(c.data),c}}function h(){return function(e){let t=9.109383*1e-30,n=1602177e-24,i=299792458;return 662607e-39/Math.sqrt(2*t*n*e)/Math.sqrt(1+n*e/2/t/i/i)*1e11}}function v(e){return function(t){let n=9.109383*1e-30,i=1602177e-24,a=299792458,r=e(t);return 2*Math.PI/r/t*(n*a*a+i*t)/(2*n*a*a+i*t)}}function g(e,t,n,i,a,r,o){return class{constructor(t,n,i,a,r){this._gpts=t.slice(),this._sampling=n.slice(),this._energy=i,this._wavelength=e(i),this._semiangle_cutoff=a,this._defocus=r}_get_scattering_angles(){let e=t(this._gpts[0],this._sampling[0]),r=t(this._gpts[1],this._sampling[1]),[o,l]=n(e,r);return[i.sqrt(i.add(o.multiply(o.multiply(this._wavelength*this._wavelength)),l.multiply(l.multiply(this._wavelength*this._wavelength)))),a(o,l)]}_evaluate_aberrations(e,t){let n=this._defocus/this._wavelength*Math.PI,a=e.multiply(e).multiply(n),o=i.cos(a),l=i.sin(a),s=new r(a.shape);return s.data=i.stack([o,l],-1),s}_evaluate_aperture(e,t){let n=this._semiangle_cutoff/1e3,a=new r(e.shape),l=o(e,n);return a.data=i.stack([l,i.zeros(e.shape)],-1),a}build(){let[e,t]=this._get_scattering_angles(),n=this._evaluate_aberrations(e,t),a=this._evaluate_aperture(e,t),o=n.multiply(a),l=new r(o.shape);l.data=i.ifft(o.data);let s=Math.sqrt(l.abs_sqr().sum());return this._array=l.scalar_multiply(1/s,0),this}}}function y(e){return e`https://observablehq.com/@mootari/notebook-data`}function w(e,t){const n=e.module();return n.variable(t()).define(["md"],i),n.variable(t()).define(["htl"],a),n.variable(t("nj")).define("nj",["require"],r),n.variable(t("ops")).define("ops",["require"],o),n.variable(t("cops")).define("cops",["require"],l),n.variable(t("atan2")).define("atan2",["nj","ops"],s),n.variable(t("lt_int_s")).define("lt_int_s",["nj","ops"],u),n.variable(t("ComplexNDArray")).define("ComplexNDArray",["nj","atan2","cops"],c),n.variable(t("fftfreq")).define("fftfreq",["nj"],p),n.variable(t("meshgrid2D")).define("meshgrid2D",["nj"],d),n.variable(t("fftshift2D")).define("fftshift2D",["nj"],f),n.variable(t("fourier_shift")).define("fourier_shift",["ComplexNDArray","nj","fftfreq","meshgrid2D"],_),n.variable(t("corner_crop")).define("corner_crop",["ComplexNDArray"],m),n.variable(t("fourier_downsample")).define("fourier_downsample",["ComplexNDArray","nj","corner_crop"],b),n.variable(t("electron_wavelength_angstroms")).define("electron_wavelength_angstroms",h),n.variable(t("electron_interaction_parameter")).define("electron_interaction_parameter",["electron_wavelength_angstroms"],v),n.variable(t("ComplexProbe")).define("ComplexProbe",["electron_wavelength_angstroms","fftfreq","meshgrid2D","nj","atan2","ComplexNDArray","lt_int_s"],g),n.variable(t()).define(["md"],y),n}function x(e){return e`# Extended Ptychographic Iterative Engine

Here, we will use the extended ptychographic iterative engine (ePIE) to reconstruct the electrostatic potential of an fcc-like material made of 7 [111] atomic layers.`}function z(e){return e`First, hover over the probe intensity visualization to move the probe position around and see how the diffraction pattern below changes.`}function k(e){return e.range([100,500],{value:250,step:1,label:"Visualization width"})}function j(e,t,n,i,a,r,o,l){let s=[];return e.includes("probe")&&(s=[...s,t]),e.includes("diffraction")&&(s=[...s,n]),e.includes("gradient")&&(s=[...s,i]),e.includes("potential")&&(s=[...s,a]),r`<div style="display:flex; flex-wrap: wrap;">

${s.map((e=>o.legend({width:l,marginLeft:10,marginRight:10,label:e.label,color:{domain:e.domain,scheme:e.scheme,type:e.type,exponent:e.exponent,style:{background:"none"}}})))}`}function q(e,t,n,i,a,r,o,l,s,u,c,p){let d=10,f=[];e.includes("probe")&&(f=[...f,t]),e.includes("diffraction")&&(f=[...f,n]),e.includes("gradient")&&(f=[...f,i]),e.includes("potential")&&(f=[...f,a]);let _=f.length,m=r*_,b=r/o[0]*o[1];return l.plot({width:m,height:b-20,padding:0,margin:0,x:{axis:null,range:[0,m]},y:{axis:null,range:[0,b]},marks:[l.cell(s.cross(s.range(_),[0]).map((([e,t])=>({a:e,b:t}))),{x:"a",y:"b",render:(e,{x:t,y:n},{x:i,y:a,channels:{x:{value:r},y:{value:o}}})=>s.create("svg:g").call((o=>o.selectAll().data(e).join("g").attr("transform",(e=>`translate(${i[e]+d},${a[e]})`)).append((e=>u(f,r[e],t.bandwidth()-20,n.bandwidth()-20))))).on("pointerenter pointermove",(e=>c.value=p(s.pointer(e),[d,0],[t.bandwidth()-20,n.bandwidth()-20]))).node()})]})}function D(e){return e`## Gradient Descent Intuition

Toggling the "gradient" and "potential" checkboxes below will plot the phase update on the reconstructed potential in the current probe position.`}function P(e){return e.checkbox(["probe","diffraction","gradient","potential"],{value:["probe","diffraction"],label:"Visualization Panels: "})}function C(e){return e.button("Reset Potential and Probe Position")}function M(e){return e`## Reactive Reconstruction
Toggle the "reconstruct" checkbox below to start a reactive reconstruction!`}function A(e){return e.toggle({label:"Reconstuct"})}function I(e){return e`This converges rather slowly when we scan in a raster. Toggling the "Randomize order" checkbox below will instead perform stochastic gradient descent.`}function N(e){return e.toggle({label:"Randomize Order",value:!1})}function R(e){return e.html`<hr class="hideable-md">`}async function G(e,t){let n=new Float32Array(await e("FCC-slab-dps-25x25x96x96-float32.npy").arrayBuffer()),i=Array.from(n),a=t.zeros([25,25,96,96]);return a.selection.data=i,t.sqrt(a)}function F(e,t,n,i){if(e.includes("diffraction")){let e=t(n.pick(i[1]/4,i[0]/4,null,null).pow(2));return{label:"Diffraction Intensity",scheme:"Magma",domain:[0,.003],type:"pow",exponent:.5,width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}}function T(e){return e.shape.slice(2)}function E(e,t){return new e(t,[.255,.255],8e4,25,150).build()}function $(e,t,n,i){let a=e(t._array,[-n[1],-n[0]]).abs_sqr();return{label:"Illuminating Probe Intensity",scheme:"Greys",domain:[0,i],width:a.shape[1],height:a.shape[0],values:a.flatten().tolist()}}function H(e){return e._array.abs_sqr().max()}function L(e,t){let n=[];for(let i=0;i<e[0];i+=4)for(let t=0;t<e[1];t+=4)n=[...n,{x:i,y:t}];return t.rect(n,t.pointer({x1:"x",x2:e=>e.x+4,y1:"y",y2:e=>e.y+4,stroke:"none",fill:"none"}))}function O(e,t){return function(n,i){let a=i.clone(),r=new e(n.shape),o=t.cos(n),l=t.sin(n);return r.data=t.stack([o,l],-1),a=a.multiply(r),[a,r]}}function S(e,t){return function(n,i){let a=new e(i.shape);a.data=t.fft(i.data);let r=a.angle(),o=new e(i.shape),l=t.cos(r),s=t.sin(r);o.data=t.stack([l,s],-1),o=o.real_multiply(n);let u=o.subtract(a),c=new e(i.shape);return c.data=t.ifft(u.data),c}}function V(e,t){return e.zeros(t)}function B(e,t){return e.zeros(t)}function U(e){return{label:"Reconstructed Potential",scheme:"Magma",domain:[0,.75*e.max()+1e-4],width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}function W(e,t){return function(n,i,a){let[r,o]=e(n,i);return[o,t(a,r)]}}function Z(e,t,n,i,a,r){return function(o,[l,s],u){let c=l/4,p=(e[1]-s)%e[1]/4,d=t.pick(p,c,null,null),f=n(i._array,[-s,-l]),[_,m]=a(o,f,d),b=m.multiply(_.conjugate()).multiply(f.conjugate()).scalar_multiply(0,-1/r);return o.add(b.re().multiply(u))}}function J(e,t,n){return e(t,n,1)}function K(e,t){let n=e.subtract(t);return{label:"Gradient Descent Step",scheme:"PuOr",domain:[n.min(),n.max()],width:n.shape[1],height:n.shape[0],values:n.flatten().tolist()}}function Q(e){return function(t){return e.clip(t,0)}}function X(e,t){if(e){let e=t.randomInt(25);return[4*e(),4*e()]}return[0,0]}function Y(){return null}function ee(e){return[e[0]/2,e[1]/2]}function te(e,t,n,i){let a=!1;return null!==e&&(e[0]==t[0]&&e[1]==n[1]-t[1]||(a=!0,i.value=[e[0],n[1]-e[1]])),a}function ne(e,t,n,i,a,r,o,l,s,u,c){if(e){if(t){let e=n.randomInt(25),t=4*e(),a=4*e();i.value=[t,a]}else a[0]+4<100?i.value=[a[0]+4,a[1]]:a[1]+4<100?i.value=[0,a[1]+4]:i.value=[a[0]+4,0];let e=r(o,a,1);l.value=s(e)}else u||(c.value=o.clone())}function ie(e,t,n,i,a,r,o,l,s,u){e&&t.includes("gradient")&&(n.value=i(a,r,1),t.includes("potential")&&(o.value=l(s),u.value=a.clone()))}function ae(e,t,n,i,a,r,o,l){e&&(t.value=null,n.value=i.zeros(a),r.value=i.zeros(a),o.value=[a[0]/2,a[1]/2],l.value=[0,0])}function re(e){return(t,n,i,a)=>e.plot({width:i,height:a,margin:0,x:{axis:null},y:{axis:null},color:{label:t[n].label,domain:t[n].domain,scheme:t[n].scheme,type:t[n].type,exponent:t[n].exponent,style:{background:"none"}},style:{background:"none"},marks:[e.raster(t[n].values,{width:t[n].width,height:t[n].height}),e.frame({strokeWidth:1})]})}function oe(e){return function([t,n],[i,a],[r,o]){let[l,s]=[(t-i)/r,(n-a)/o];return l>1?null:[4*Math.round(l*e[0]/4),4*Math.round(s*e[1]/4)]}}function le(e,t){const i=e.module();const a=new Map([["FCC-slab-dps-25x25x96x96-float32.npy",{url:new URL(n(191),n.b),mimeType:"application/octet-stream",toString:function(){return this.url}}]]);i.builtin("FileAttachment",e.fileAttachments((e=>a.get(e)))),i.variable(t()).define(["md"],x),i.variable(t()).define(["md"],z),i.variable(t("viewof viz_width")).define("viewof viz_width",["Inputs"],k),i.variable(t("viz_width")).define("viz_width",["Generators","viewof viz_width"],((e,t)=>e.input(t))),i.variable(t("visualization_legends")).define("visualization_legends",["visualization_checkboxes","probe_dictionary","dp_dictionary","gradient_dictionary","potential_dictionary","html","Plot","viz_width"],j),i.variable(t("main_visualization")).define("main_visualization",["visualization_checkboxes","probe_dictionary","dp_dictionary","gradient_dictionary","potential_dictionary","viz_width","gpts","Plot","d3","raster_subplot","mutable mouse_pos","left_panel_pixels_to_pos"],q),i.variable(t()).define(["md"],D),i.variable(t("viewof visualization_checkboxes")).define("viewof visualization_checkboxes",["Inputs"],P),i.variable(t("visualization_checkboxes")).define("visualization_checkboxes",["Generators","viewof visualization_checkboxes"],((e,t)=>e.input(t))),i.variable(t("viewof reset_potential_and_probe_position")).define("viewof reset_potential_and_probe_position",["Inputs"],C),i.variable(t("reset_potential_and_probe_position")).define("reset_potential_and_probe_position",["Generators","viewof reset_potential_and_probe_position"],((e,t)=>e.input(t))),i.variable(t()).define(["md"],M),i.variable(t("viewof reconstruct")).define("viewof reconstruct",["Inputs"],A),i.variable(t("reconstruct")).define("reconstruct",["Generators","viewof reconstruct"],((e,t)=>e.input(t))),i.variable(t()).define(["md"],I),i.variable(t("viewof random_order")).define("viewof random_order",["Inputs"],N),i.variable(t("random_order")).define("random_order",["Generators","viewof random_order"],((e,t)=>e.input(t))),i.variable(t()).define(["htl"],R);const r=e.module(w);return i.import("nj",r),i.import("ComplexNDArray",r),i.import("fftfreq",r),i.import("fftshift2D",r),i.import("meshgrid2D",r),i.import("fourier_shift",r),i.import("fourier_downsample",r),i.import("ComplexProbe",r),i.variable(t("diffraction_amplitudes")).define("diffraction_amplitudes",["FileAttachment","nj"],G),i.variable(t("dp_dictionary")).define("dp_dictionary",["visualization_checkboxes","fftshift2D","diffraction_amplitudes","probe_xy"],F),i.variable(t("gpts")).define("gpts",["diffraction_amplitudes"],T),i.variable(t("real_space_probe")).define("real_space_probe",["ComplexProbe","gpts"],E),i.variable(t("probe_dictionary")).define("probe_dictionary",["fourier_shift","real_space_probe","probe_xy","probe_normalization"],$),i.variable(t("probe_normalization")).define("probe_normalization",["real_space_probe"],H),i.variable(t("mouseover_pointer")).define("mouseover_pointer",["gpts","Plot"],L),i.variable(t("overlap_projection")).define("overlap_projection",["ComplexNDArray","nj"],O),i.variable(t("fourier_projection")).define("fourier_projection",["ComplexNDArray","nj"],S),i.define("initial potential",["nj","gpts"],V),i.variable(t("mutable potential")).define("mutable potential",["Mutable","initial potential"],((e,t)=>new e(t))),i.variable(t("potential")).define("potential",["mutable potential"],(e=>e.generator)),i.define("initial potential_static",["nj","gpts"],B),i.variable(t("mutable potential_static")).define("mutable potential_static",["Mutable","initial potential_static"],((e,t)=>new e(t))),i.variable(t("potential_static")).define("potential_static",["mutable potential_static"],(e=>e.generator)),i.variable(t("potential_dictionary")).define("potential_dictionary",["potential"],U),i.variable(t("forward_operator")).define("forward_operator",["overlap_projection","fourier_projection"],W),i.variable(t("gradient_descent")).define("gradient_descent",["gpts","diffraction_amplitudes","fourier_shift","real_space_probe","forward_operator","probe_normalization"],Z),i.define("initial gradient_step",["gradient_descent","potential_static","probe_xy"],J),i.variable(t("mutable gradient_step")).define("mutable gradient_step",["Mutable","initial gradient_step"],((e,t)=>new e(t))),i.variable(t("gradient_step")).define("gradient_step",["mutable gradient_step"],(e=>e.generator)),i.variable(t("gradient_dictionary")).define("gradient_dictionary",["gradient_step","potential_static"],K),i.variable(t("positivity_constraint")).define("positivity_constraint",["nj"],Q),i.define("initial reconstruct_xy",["random_order","d3"],X),i.variable(t("mutable reconstruct_xy")).define("mutable reconstruct_xy",["Mutable","initial reconstruct_xy"],((e,t)=>new e(t))),i.variable(t("reconstruct_xy")).define("reconstruct_xy",["mutable reconstruct_xy"],(e=>e.generator)),i.define("initial mouse_pos",Y),i.variable(t("mutable mouse_pos")).define("mutable mouse_pos",["Mutable","initial mouse_pos"],((e,t)=>new e(t))),i.variable(t("mouse_pos")).define("mouse_pos",["mutable mouse_pos"],(e=>e.generator)),i.define("initial probe_xy",["gpts"],ee),i.variable(t("mutable probe_xy")).define("mutable probe_xy",["Mutable","initial probe_xy"],((e,t)=>new e(t))),i.variable(t("probe_xy")).define("probe_xy",["mutable probe_xy"],(e=>e.generator)),i.variable(t("probe_moving")).define("probe_moving",["mouse_pos","probe_xy","gpts","mutable probe_xy"],te),i.variable(t("recontruct_mutable")).define("recontruct_mutable",["reconstruct","random_order","d3","mutable reconstruct_xy","reconstruct_xy","gradient_descent","potential","mutable potential","positivity_constraint","probe_moving","mutable potential_static"],ne),i.variable(t("moving_mutable")).define("moving_mutable",["probe_moving","visualization_checkboxes","mutable gradient_step","gradient_descent","potential_static","probe_xy","mutable potential_static","positivity_constraint","gradient_step","mutable potential"],ie),i.variable(t("reset_potential_mutable")).define("reset_potential_mutable",["reset_potential_and_probe_position","mutable mouse_pos","mutable potential","nj","gpts","mutable potential_static","mutable probe_xy","mutable reconstruct_xy"],ae),i.variable(t("raster_subplot")).define("raster_subplot",["Plot"],re),i.variable(t("left_panel_pixels_to_pos")).define("left_panel_pixels_to_pos",["gpts"],oe),i}function se(e){return e}function ue(e){return e}function ce(e){return e}function pe(e){return e}function de(e){return e}function fe(e){return e}function _e(e){return e}function me(e){return e.html`<hr class="hideable-md">`}function be(e){return e}function he(e){return e}function ve(e){return e}function ge(e,t){const n=e.module();n.variable(t()).define(["viewof viz_width"],se),n.variable(t()).define(["visualization_legends"],ue),n.variable(t()).define(["main_visualization"],ce),n.variable(t()).define(["viewof visualization_checkboxes"],pe),n.variable(t()).define(["viewof reset_potential_and_probe_position"],de),n.variable(t()).define(["viewof reconstruct"],fe),n.variable(t()).define(["viewof random_order"],_e),n.variable(t()).define(["htl"],me);const i=e.module(le);return n.import("viewof viz_width",i),n.import("viz_width",i),n.import("visualization_legends",i),n.import("main_visualization",i),n.import("viewof visualization_checkboxes",i),n.import("visualization_checkboxes",i),n.import("viewof reset_potential_and_probe_position",i),n.import("reset_potential_and_probe_position",i),n.import("viewof reconstruct",i),n.import("reconstruct",i),n.import("viewof random_order",i),n.import("random_order",i),n.import("reset_potential_mutable",i),n.import("recontruct_mutable",i),n.import("moving_mutable",i),n.variable(t()).define(["reset_potential_mutable"],be),n.variable(t()).define(["recontruct_mutable"],he),n.variable(t()).define(["moving_mutable"],ve),n}n.d(t,{Z:()=>ge})}}]);