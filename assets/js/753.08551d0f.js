"use strict";(self.webpackChunk_2023_mm_presentation=self.webpackChunk_2023_mm_presentation||[]).push([[753],{191:(e,t,i)=>{e.exports=i.p+"631f8cfa3d6bae2a.bin"},6753:(e,t,i)=>{function n(e){return e`# Ptychography Helper Functions`}function r(e){return e.html`<hr class="hideable-md">`}function a(e){return e("https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.16/dist/numjs.min.js")}function o(e){return e("https://bundle.run/ndarray-ops@1.2.2")}function l(e){return e("https://bundle.run/ndarray-complex@1.0.3")}function s(e,t){return function(i,n){let r=e.zeros(i.shape);return t.atan2(r.selection,i.selection,n.selection),r}}function u(e,t){return function(i,n){let r=e.zeros(i.shape);return t.lts(r.selection,i.selection,n),t.bandseq(r.selection,1),r}}function c(e,t,i){return class n{constructor(t){this.shape=t;let i=t.slice();i.push(2),this.data=e.zeros(i),this._nulls=new Array(t.length).fill(null)}re(){return this.data.pick(...this._nulls,0)}im(){return this.data.pick(...this._nulls,1)}abs(){return e.sqrt(this.abs_sqr())}abs_sqr(){return e.add(this.re().multiply(this.re()),this.im().multiply(this.im()))}angle(){return t(this.im(),this.re())}clone(){let e=new n(this.shape);return e.data=this.data.clone(),e}conjugate(){let t=this.re().clone(),r=this.im().clone();i.conjeq(t.selection,r.selection);let a=new n(this.shape);return a.data=e.stack([t,r],-1),a}multiply(t){let r=this.re().clone(),a=this.im().clone(),o=t.re(),l=t.im();i.muleq(r.selection,a.selection,o.selection,l.selection);let s=new n(this.shape);return s.data=e.stack([r,a],-1),s}real_multiply(t){let r=this.re().clone(),a=this.im().clone(),o=t,l=e.zeros(t.shape);i.muleq(r.selection,a.selection,o.selection,l.selection);let s=new n(this.shape);return s.data=e.stack([r,a],-1),s}scalar_multiply(t,r){let a=this.re().clone(),o=this.im().clone();i.mulseq(a.selection,o.selection,t,r);let l=new n(this.shape);return l.data=e.stack([a,o],-1),l}add(t){let r=this.re().clone(),a=this.im().clone(),o=t.re(),l=t.im();i.addeq(r.selection,a.selection,o.selection,l.selection);let s=new n(this.shape);return s.data=e.stack([r,a],-1),s}subtract(t){let r=this.re().clone(),a=this.im().clone(),o=t.re(),l=t.im();i.subeq(r.selection,a.selection,o.selection,l.selection);let s=new n(this.shape);return s.data=e.stack([r,a],-1),s}}}function p(e){return function(t,i){let n=e.zeros(t),r=1/(t*i),a=1+((t-1)/2|0);for(var o=0;o<a;o++)n.set(o,o*r);for(o=a;o<t;o++)n.set(o,(o-t)*r);return n}}function d(e){return function(t,i){let n=[t.size,i.size],r=[];r[0]=e.zeros(n),r[1]=e.zeros(n);for(let e=0;e<n[1];e++)for(let a=0;a<n[0];a++)r[0].set(a,e,t.get(a)),r[1].set(a,e,i.get(e));return r}}function f(e){return function(t){let[i,n]=t.shape,r=i/2|0,a=n/2|0,o=e.zeros([i,n]);return o.slice([null,r],[null,a]).assign(t.slice(-r,-a),!1),o.slice([null,r],a).assign(t.slice(-r,[null,a]),!1),o.slice(-r,-a).assign(t.slice([null,r],[null,a]),!1),o.slice(-r,[null,a]).assign(t.slice([null,r],-a),!1),o}}function _(e,t,i,n){return function(r,a){let[o,l]=r.shape,[s,u]=a,c=new e([o,l]);c.data=t.fft(r.data);let p=i(o,1),d=i(l,1),[f,_]=n(p,d),h=-2*Math.PI,m=t.add(f.multiply(s),_.multiply(u)).multiply(h),b=new e([o,l]),v=t.cos(m),g=t.sin(m);b.data=t.stack([v,g],-1);let w=c.multiply(b);return w.data=t.ifft(w.data),w}}function h(e){return function(t,[i,n]){let r=new e([i,n]),a=i/2|0,o=n/2|0;return r.data.slice([null,a],[null,o],null).assign(t.slice([null,a],[null,o],null),!1),r.data.slice(-a,[null,o],null).assign(t.slice(-a,[null,o],null),!1),r.data.slice([null,a],-o,null).assign(t.slice([null,a],-o,null),!1),r.data.slice(-a,-o,null).assign(t.slice(-a,-o,null),!1),r}}function m(e,t,i){return function(n,r){let[a,o]=n.shape;console.log(a);let l=new e([a,o]);l.data=t.fft(n.data);let[s,u]=[a/r|0,o/r|0],c=i(l.data,[s,u]);return c.data=t.ifft(c.data),c}}function b(){return function(e){let t=9.109383*1e-30,i=1602177e-24,n=299792458;return 662607e-39/Math.sqrt(2*t*i*e)/Math.sqrt(1+i*e/2/t/n/n)*1e11}}function v(e){return function(t){let i=9.109383*1e-30,n=1602177e-24,r=299792458,a=e(t);return 2*Math.PI/a/t*(i*r*r+n*t)/(2*i*r*r+n*t)}}function g(e,t,i,n,r,a,o){return class{constructor(t,i,n,r,a){this._gpts=t.slice(),this._sampling=i.slice(),this._energy=n,this._wavelength=e(n),this._semiangle_cutoff=r,this._defocus=a}_get_scattering_angles(){let e=t(this._gpts[0],this._sampling[0]),a=t(this._gpts[1],this._sampling[1]),[o,l]=i(e,a);return[n.sqrt(n.add(o.multiply(o.multiply(this._wavelength*this._wavelength)),l.multiply(l.multiply(this._wavelength*this._wavelength)))),r(o,l)]}_evaluate_aberrations(e,t){let i=this._defocus/this._wavelength*Math.PI,r=e.multiply(e).multiply(i),o=n.cos(r),l=n.sin(r),s=new a(r.shape);return s.data=n.stack([o,l],-1),s}_evaluate_aperture(e,t){let i=this._semiangle_cutoff/1e3,r=new a(e.shape),l=o(e,i);return r.data=n.stack([l,n.zeros(e.shape)],-1),r}build(){let[e,t]=this._get_scattering_angles(),i=this._evaluate_aberrations(e,t),r=this._evaluate_aperture(e,t),o=i.multiply(r),l=new a(o.shape);l.data=n.ifft(o.data);let s=Math.sqrt(l.abs_sqr().sum());return this._array=l.scalar_multiply(1/s,0),this}}}function w(e,t){const i=e.module();return i.variable(t()).define(["md"],n),i.variable(t()).define(["htl"],r),i.variable(t("nj")).define("nj",["require"],a),i.variable(t("ops")).define("ops",["require"],o),i.variable(t("cops")).define("cops",["require"],l),i.variable(t("atan2")).define("atan2",["nj","ops"],s),i.variable(t("lt_int_s")).define("lt_int_s",["nj","ops"],u),i.variable(t("ComplexNDArray")).define("ComplexNDArray",["nj","atan2","cops"],c),i.variable(t("fftfreq")).define("fftfreq",["nj"],p),i.variable(t("meshgrid2D")).define("meshgrid2D",["nj"],d),i.variable(t("fftshift2D")).define("fftshift2D",["nj"],f),i.variable(t("fourier_shift")).define("fourier_shift",["ComplexNDArray","nj","fftfreq","meshgrid2D"],_),i.variable(t("corner_crop")).define("corner_crop",["ComplexNDArray"],h),i.variable(t("fourier_downsample")).define("fourier_downsample",["ComplexNDArray","nj","corner_crop"],m),i.variable(t("electron_wavelength_angstroms")).define("electron_wavelength_angstroms",b),i.variable(t("electron_interaction_parameter")).define("electron_interaction_parameter",["electron_wavelength_angstroms"],v),i.variable(t("ComplexProbe")).define("ComplexProbe",["electron_wavelength_angstroms","fftfreq","meshgrid2D","nj","atan2","ComplexNDArray","lt_int_s"],g),i}function y(e){return e`# Extended Ptychographic Iterative Engine

Here, we will use the extended ptychographic iterative engine (ePIE) to reconstruct the electrostatic potential of an fcc-like material made of 7 [111] atomic layers.`}function x(e){return e`First, hover over the probe intensity visualization to move the probe position around and see how the diffraction pattern below changes.`}function z(e){return e.range([100,500],{value:350,step:1,label:"Visualization width"})}function k(e,t,i,n){return e.plot({color:{label:t.label,scheme:t.scheme,style:{background:"none"}},style:{background:"none"},x:{axis:!1},y:{axis:!1},width:i,height:i,marginRight:10,marks:[e.raster(t.values,{width:t.width,height:t.height}),n]})}function j(e,t,i,n,r,a,o){let l=[];return e.includes("diffraction")&&(l=[...l,t]),e.includes("gradient")&&(l=[...l,i]),e.includes("potential")&&(l=[...l,n]),r`<div style="display:flex; flex-wrap: wrap;">
 ${l.map((e=>a.plot({color:{label:e.label,domain:e.domain,scheme:e.scheme,type:e.type,exponent:e.exponent,legend:!0,style:{background:"none",width:3*o/4}},x:{axis:!1},y:{axis:!1},style:{background:"none"},width:o,height:o-10,marginRight:10,marks:[a.raster(e.values,{width:e.width,height:e.height})]})))}`}function q(e){return e`## Gradient Descent Intuition

Toggling the "gradient" and "potential" checkboxes below will plot the phase update on the reconstructed potential in the current probe position.`}function D(e){return e.checkbox(["diffraction","gradient","potential"],{value:["diffraction"],label:"Visualization Panels: "})}function P(e){return e.button("Reset Potential and Probe Position")}function C(e){return e`## Reactive Reconstruction
Toggle the "reconstruct" checkbox below to start a reactive reconstruction!`}function I(e){return e.toggle({label:"Reconstuct"})}function A(e){return e`This converges rather slowly when we scan in a raster. Toggling the "Randomize order" checkbox below will instead perform stochastic gradient descent.`}function M(e){return e.toggle({label:"Randomize Order",value:!1})}function R(e){return e.html`<hr class="hideable-md">`}async function G(e,t){let i=new Float32Array(await e("FCC-slab-dps-25x25x96x96-float32.npy").arrayBuffer()),n=Array.from(i),r=t.zeros([25,25,96,96]);return r.selection.data=n,t.sqrt(r)}function N(e,t,i,n){if(e.includes("diffraction")){let e=t(i.pick(n[1]/4,n[0]/4,null,null).pow(2));return{label:"Diffraction Intensity",scheme:"Magma",domain:[0,.003],type:"pow",exponent:.5,width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}}function F(e){return e.shape.slice(2)}function T(e,t){return new e(t,[.255,.255],8e4,25,150).build()}function E(e,t,i){let n=e(t._array,[-i[1],-i[0]]).abs_sqr();return{label:"Illuminating Probe Intensity",scheme:"Greys",width:n.shape[1],height:n.shape[0],values:n.flatten().tolist()}}function H(e){return e._array.abs_sqr().max()}function O(e,t){let i=[];for(let n=0;n<e[0];n+=4)for(let t=0;t<e[1];t+=4)i=[...i,{x:n,y:t}];return t.rect(i,t.pointer({x1:"x",x2:e=>e.x+4,y1:"y",y2:e=>e.y+4,stroke:"none",fill:"none"}))}function S(e,t){return function(i,n){let r=n.clone(),a=new e(i.shape),o=t.cos(i),l=t.sin(i);return a.data=t.stack([o,l],-1),r=r.multiply(a),[r,a]}}function V(e,t){return function(i,n){let r=new e(n.shape);r.data=t.fft(n.data);let a=r.angle(),o=new e(n.shape),l=t.cos(a),s=t.sin(a);o.data=t.stack([l,s],-1),o=o.real_multiply(i);let u=o.subtract(r),c=new e(n.shape);return c.data=t.ifft(u.data),c}}function B(e,t){return e.zeros(t)}function L(e,t){return e.zeros(t)}function U(e){return{label:"Reconstructed Potential",scheme:"Magma",domain:[0,.75*e.max()+1e-4],width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}function Z(e,t,i){return e(t,i,1)}function $(e,t,i,n,r,a,o,l,s){e&&t.includes("gradient")&&(i.value=n(r,a,1),t.includes("potential")&&(o.value=l(s)));let u=s.subtract(r);return{label:"Gradient Descent Step",scheme:"PuOr",width:u.shape[1],height:u.shape[0],values:u.flatten().tolist()}}function J(e,t){return function(i,n,r){let[a,o]=e(i,n);return[o,t(r,a)]}}function K(e,t,i,n,r,a){return function(o,[l,s],u){let c=l/4,p=(e[1]-s)%e[1]/4,d=t.pick(p,c,null,null),f=i(n._array,[-s,-l]),[_,h]=r(o,f,d),m=h.multiply(_.conjugate()).multiply(f.conjugate()).scalar_multiply(0,-1/a);return o.add(m.re().multiply(u))}}function Q(e){return function(t){return e.clip(t,0)}}function W(e,t){if(e){let e=t.randomInt(25);return[4*e(),4*e()]}return[0,0]}function X(e){return[e[0]/2,e[1]/2]}function Y(e,t,i){let n=!1;return null!==e&&(e.x==t[0]&&e.y==t[1]||(n=!0),i.value=[e.x,e.y]),n}function ee(e,t,i,n,r,a,o,l,s,u,c){if(e){if(t){let e=i.randomInt(25),t=4*e(),r=4*e();n.value=[t,r]}else r[0]+4<100?n.value=[r[0]+4,r[1]]:r[1]+4<100?n.value=[0,r[1]+4]:n.value=[r[0]+4,0];let e=a(o,r,1);l.value=s(e)}else u||(c.value=o.clone())}function te(e,t,i,n,r,a,o){e&&(t.value=i.zeros(n),r.value=i.zeros(n),a.value=[n[0]/2,n[1]/2],o.value=[0,0])}function ie(e,t){const n=e.module();const r=new Map([["FCC-slab-dps-25x25x96x96-float32.npy",{url:new URL(i(191),i.b),mimeType:"application/octet-stream",toString:function(){return this.url}}]]);n.builtin("FileAttachment",e.fileAttachments((e=>r.get(e)))),n.variable(t()).define(["md"],y),n.variable(t()).define(["md"],x),n.variable(t("viewof viz_width")).define("viewof viz_width",["Inputs"],z),n.variable(t("viz_width")).define("viz_width",["Generators","viewof viz_width"],((e,t)=>e.input(t))),n.variable(t("viewof mouseover_potential")).define("viewof mouseover_potential",["Plot","probe_dictionary","viz_width","mouseover_pointer"],k),n.variable(t("mouseover_potential")).define("mouseover_potential",["Generators","viewof mouseover_potential"],((e,t)=>e.input(t))),n.variable(t("main_visualization")).define("main_visualization",["visualization_checkboxes","dp_dictionary","gradient_dictionary","potential_dictionary","html","Plot","viz_width"],j),n.variable(t()).define(["md"],q),n.variable(t("viewof visualization_checkboxes")).define("viewof visualization_checkboxes",["Inputs"],D),n.variable(t("visualization_checkboxes")).define("visualization_checkboxes",["Generators","viewof visualization_checkboxes"],((e,t)=>e.input(t))),n.variable(t("viewof reset_potential_and_probe_position")).define("viewof reset_potential_and_probe_position",["Inputs"],P),n.variable(t("reset_potential_and_probe_position")).define("reset_potential_and_probe_position",["Generators","viewof reset_potential_and_probe_position"],((e,t)=>e.input(t))),n.variable(t()).define(["md"],C),n.variable(t("viewof reconstruct")).define("viewof reconstruct",["Inputs"],I),n.variable(t("reconstruct")).define("reconstruct",["Generators","viewof reconstruct"],((e,t)=>e.input(t))),n.variable(t()).define(["md"],A),n.variable(t("viewof random_order")).define("viewof random_order",["Inputs"],M),n.variable(t("random_order")).define("random_order",["Generators","viewof random_order"],((e,t)=>e.input(t))),n.variable(t()).define(["htl"],R);const a=e.module(w);return n.import("nj",a),n.import("ComplexNDArray",a),n.import("fftfreq",a),n.import("fftshift2D",a),n.import("meshgrid2D",a),n.import("fourier_shift",a),n.import("fourier_downsample",a),n.import("ComplexProbe",a),n.variable(t("diffraction_amplitudes")).define("diffraction_amplitudes",["FileAttachment","nj"],G),n.variable(t("dp_dictionary")).define("dp_dictionary",["visualization_checkboxes","fftshift2D","diffraction_amplitudes","probe_xy"],N),n.variable(t("gpts")).define("gpts",["diffraction_amplitudes"],F),n.variable(t("real_space_probe")).define("real_space_probe",["ComplexProbe","gpts"],T),n.variable(t("probe_dictionary")).define("probe_dictionary",["fourier_shift","real_space_probe","probe_xy"],E),n.variable(t("probe_normalization")).define("probe_normalization",["real_space_probe"],H),n.variable(t("mouseover_pointer")).define("mouseover_pointer",["gpts","Plot"],O),n.variable(t("overlap_projection")).define("overlap_projection",["ComplexNDArray","nj"],S),n.variable(t("fourier_projection")).define("fourier_projection",["ComplexNDArray","nj"],V),n.define("initial potential",["nj","gpts"],B),n.variable(t("mutable potential")).define("mutable potential",["Mutable","initial potential"],((e,t)=>new e(t))),n.variable(t("potential")).define("potential",["mutable potential"],(e=>e.generator)),n.define("initial potential_static",["nj","gpts"],L),n.variable(t("mutable potential_static")).define("mutable potential_static",["Mutable","initial potential_static"],((e,t)=>new e(t))),n.variable(t("potential_static")).define("potential_static",["mutable potential_static"],(e=>e.generator)),n.variable(t("potential_dictionary")).define("potential_dictionary",["potential"],U),n.define("initial gradient_step",["gradient_descent","potential_static","probe_xy"],Z),n.variable(t("mutable gradient_step")).define("mutable gradient_step",["Mutable","initial gradient_step"],((e,t)=>new e(t))),n.variable(t("gradient_step")).define("gradient_step",["mutable gradient_step"],(e=>e.generator)),n.variable(t("gradient_dictionary")).define("gradient_dictionary",["probe_moving","visualization_checkboxes","mutable gradient_step","gradient_descent","potential_static","probe_xy","mutable potential","positivity_constraint","gradient_step"],$),n.variable(t("forward_operator")).define("forward_operator",["overlap_projection","fourier_projection"],J),n.variable(t("gradient_descent")).define("gradient_descent",["gpts","diffraction_amplitudes","fourier_shift","real_space_probe","forward_operator","probe_normalization"],K),n.variable(t("positivity_constraint")).define("positivity_constraint",["nj"],Q),n.define("initial reconstruct_xy",["random_order","d3"],W),n.variable(t("mutable reconstruct_xy")).define("mutable reconstruct_xy",["Mutable","initial reconstruct_xy"],((e,t)=>new e(t))),n.variable(t("reconstruct_xy")).define("reconstruct_xy",["mutable reconstruct_xy"],(e=>e.generator)),n.define("initial probe_xy",["gpts"],X),n.variable(t("mutable probe_xy")).define("mutable probe_xy",["Mutable","initial probe_xy"],((e,t)=>new e(t))),n.variable(t("probe_xy")).define("probe_xy",["mutable probe_xy"],(e=>e.generator)),n.variable(t("probe_moving")).define("probe_moving",["mouseover_potential","probe_xy","mutable probe_xy"],Y),n.variable(t("recontruct_mutable")).define("recontruct_mutable",["reconstruct","random_order","d3","mutable reconstruct_xy","reconstruct_xy","gradient_descent","potential","mutable potential","positivity_constraint","probe_moving","mutable potential_static"],ee),n.variable(t("reset_potential_mutable")).define("reset_potential_mutable",["reset_potential_and_probe_position","mutable potential","nj","gpts","mutable potential_static","mutable probe_xy","mutable reconstruct_xy"],te),n}function ne(e){return e}function re(e){return e}function ae(e){return e}function oe(e){return e}function le(e){return e}function se(e){return e}function ue(e){return e}function ce(e){return e.html`<hr class="hideable-md">`}function pe(e){return e}function de(e){return e}function fe(e,t){const i=e.module();i.variable(t()).define(["viewof viz_width"],ne),i.variable(t()).define(["viewof mouseover_potential"],re),i.variable(t()).define(["main_visualization"],ae),i.variable(t()).define(["viewof visualization_checkboxes"],oe),i.variable(t()).define(["viewof reset_potential_and_probe_position"],le),i.variable(t()).define(["viewof reconstruct"],se),i.variable(t()).define(["viewof random_order"],ue),i.variable(t()).define(["htl"],ce);const n=e.module(ie);return i.import("viewof viz_width",n),i.import("viz_width",n),i.import("viewof mouseover_potential",n),i.import("mouseover_potential",n),i.import("main_visualization",n),i.import("viewof visualization_checkboxes",n),i.import("visualization_checkboxes",n),i.import("viewof reset_potential_and_probe_position",n),i.import("reset_potential_and_probe_position",n),i.import("viewof reconstruct",n),i.import("reconstruct",n),i.import("viewof random_order",n),i.import("random_order",n),i.import("reset_potential_mutable",n),i.import("recontruct_mutable",n),i.variable(t()).define(["reset_potential_mutable"],pe),i.variable(t()).define(["recontruct_mutable"],de),i}i.d(t,{Z:()=>fe})}}]);